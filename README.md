# MobileAppRunCarByBaiduVoiceApi
青科智能小车主要由一块树莓派核心控制板、四个直流减速电机、两节锂电池、三个超声波传感器、两个不怕光红外传感器和两个底部的光传感器组成。超声波传感器和红外传感器可以实现避障功能，底部的光传感器可以实现循迹功能。

设计分为迷宫独立程序，服务器程序和Android客户端程序。迷宫程序单独存在，为服务器程序调用，当然可以直接独立测试。服务器程序还含有方向盘控制，语音控制和路径控制的命令解析和操作逻辑。这两个程序都采用C语言编写。Android客户端含有4种功能的UI设计和命令生成并发送的逻辑。采用Java语言编写。
实现了小车的迷宫算法，方向盘控制，语音控制和路径控制功能。其中迷宫算法为优先左转的贴左墙算法；方向盘控制，虽然可以采用任意角度的控制，但是由于小车自身转角不太精确，故只采用了8个方位的控制，分别为前进，前进左转，原地左转，等8个方位，和最后一个停止控制；语音控制代码设计还是采用百度语音的离线识别api，能够识别8个方位和一个停止命令语音；路径控制可以接受任意数目的路径节点的路径图，控制小车按照路径图的路径行驶。
1 系统定义

1.1设计实现的功能

1.小车走迷宫

2.方向盘控制

3.语音控制

4.路径控制

1.2 可行性分析

1.所谓迷宫，即存在死路的带有墙壁的复杂的道路的集合。一般迷宫的路径存在不可预知性，即迷宫的路径情况不可知。所以想要小车能从迷宫路口走到迷宫出口，必然要对迷宫类型进行定义和对小车的行车逻辑进行相应的具体设计。所以我们定义小车所走的迷宫为不存在环路的迷宫，避免小车行走时出现绕环运行的情况。还有迷宫可以存在死路，那便要求小车能从死胡同中转出来。故可以采用小车贴墙走的方案，因为当小车按贴墙走时，迷宫的死胡同对于小车便成了通路，这样小车便可走出迷宫。当然我们需要定义小车贴哪边的墙行走，我们选择了左边。当然，对于迷宫的算法，我们不只设计了以上一种算法，还有相似的居中走法，在进入死胡同时进行180°原地旋转，同时可以选择左路优先和右路优先。从原理上讲，这种算法和上种算法存在一般以上的相同思想，但是由于小车的电机和超声波传感器的不精准问题导致这种算法下的小车转弯的精确性更差，所以不得不舍弃。最后，还有建立在第二种算法上的可记录型算法，即小车在行走迷宫的同时会记录自身在迷宫的转弯情况，即路径情况。通过对路径的记录和小车的实时行走的情况便可以判断出迷宫的死胡同的存在，并将其从路径记录中删除，同时让小车退回到下一条可行走的迷宫道路中，以此逻辑便可以让小车走出迷宫，并可以得到这个迷宫的正确路径。当小车再次行走这个迷宫时，便可以通过先前记录下迷宫路径记录直接找到正确路径，做出迷宫。

2.采用Android平台，方向盘UI设定为两个同心圆，一大一小，大的为基盘，小的为操作盘。将两圆绘制与自定义控件中，通过手指对手机屏幕的触摸来改变小圆的方位，并通过小圆圆心和大圆圆心的连线和屏幕水平线的夹角便可以知道应当发送怎样的方位控制命令。服务器解析并执行这样的方位控制命令。

3.采用Android平台，对于语音的识别可以采用百度语音，谷歌语音或讯飞语音。由于讯飞语音的离线识别下线了，先了解了百度语音，谷歌语音还未了解，故选择了百度语音。百度语音可以支持在线语音识别，离线语音识别，命令词唤醒等功能。由于小车WiFi并没有连接外网，故在编写识别代码时采用了离线识别api，但是由于百度语音离线识别技术有存在网络便会优先选择在线模式，故尽管代码采用离线识别api，只要联网，不管是否连入外网，都会尝试获取在线识别功能，所以识别速率会大幅降低。经测试可知，离线识别api可以在500-700ms内迅速返回识别结果，但一旦手机客户端连接到小车WiFi后识别速度在6s左右，且识别率大大下降。解决方法为将小车连入外网，便可以让客户端识别代码走在线模式，更加迅速的得到识别结果。最后将客户端识别结果转发给服务器，服务器解析并执行相应的控制命令，让小车按命名运行。
由于百度语音支持唤醒词的操作，并且通过测试，唤醒词的速率比在线识别的速率更快，因为唤醒词技术是一个本地技术，但是唤醒词的定义官方给了有一些限制，比如词长3-5汉字等，但最关键的是官方不允许一次定义过多自定义的唤醒词。一个唤醒词的bin文件中中包含最多3个。然而语音命令有前进，前进左转，左转等8个和停止1个。故采用唤醒词的方案被官方限制给抹杀了。

4.采用Android平台，首先在自定义控件中设置画布，当手指触摸到手机屏幕时，记录下触摸点，将触摸点坐标添加到路径数组中。然后绘制完成后再对路径数组中的触摸点进行路径分析，解析成一个包含路径信息的字符串，发送给服务器。最后服务器解析后按照解析后的路径信息执行响应的控制命令。绘制后的路径数组解析可以按照以下原则进行解析。首先将前两个点的连线和垂直线进行角度计算和方向判定，并计算出连线的距离，将这3个结果拼接成命令字符串。然后将第3点和第2点连线和第2点和第1点连线进行先前的计算操作。以此类推直至全部的路径节点都被计算分析。最终发送命令字符串到客户端。

1.3 需求分析
1.小车走迷宫，需要小车的电机控制，控制小车前进后退左转右转。需要小车的超声波传感器的距离检测，来监控小车是否碰壁和是否存在可走路径。

2.方向盘控制，需要方向盘的UI设计和逻辑输出，通过确定方向盘的变化来控制小车的运行状况。

3.语音控制，需要语音识别接口，如百度语音识别。语音输入，百度语音识别，获取正确的识别结果，发送至服务器控制小车运行状态。

4.路径控制，需要自定义路径绘制控件和路径解析逻辑，发送服务器，服务器再解析，控制小车行走。

2 系统总体设计

2.1 总体设计方案的确定

首先要分为客户端程序和服务器程序，客户端程序为Android程序，使用Android Stduio开发软件。服务器程序为C语言程序，使用notepad++这个一般的文本编辑器来开发。分为服务器程序和单独的迷宫程序。

2.2 软硬件功能划分

硬件功能：小车电机控制，超声波传感器控制
软件功能：Android客户端设计，即迷宫界面设计，方向盘界面和逻辑设计，语音界面设计，路径界面和逻辑设计。服务端命令解析系统。

2.3 硬件体系架构设计

采用wiringPi树莓派开发库，便捷开发小车电机控制和超声波传感器控制。

2.4 软件体系架构设计

Android客户端：只有一个Activity其中包含一个ViewPager，ViewPager中包含4个自定义Fragment界面，每个Fragment界面代表一个功能界面。

服务端命令解析系统：建立Socket服务器，读取来至Android客户端的命令数据，初步解析后分发给对应功能类型的处理函数处理。
